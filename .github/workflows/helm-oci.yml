name: Helm OCI Push

on:
    release:
        types: [published]
    workflow_dispatch:
        inputs:
            chart_version:
                description: "Chart version to push"
                required: true
                default: "0.1.0"

permissions:
    contents: read
    packages: write

env:
    REGISTRY: ghcr.io
    CHART_NAME: kubecrsh

jobs:
    push:
        name: Push to OCI Registry
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Set up Helm
              uses: azure/setup-helm@v4
              with:
                  version: v3.14.0

            - name: Login to GHCR
              run: |
                  echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

            - name: Get version
              id: version
              run: |
                  if [ "${{ github.event_name }}" = "release" ]; then
                    VERSION="${{ github.ref_name }}"
                    VERSION="${VERSION#v}"
                  else
                    VERSION="${{ github.event.inputs.chart_version }}"
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Update Chart Version
              run: |
                  sed -i "s/^version:.*/version: ${{ steps.version.outputs.version }}/" charts/kubecrsh/Chart.yaml
                  sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.version }}\"/" charts/kubecrsh/Chart.yaml

            - name: Package Chart
              run: helm package charts/kubecrsh -d dist/

            - name: Push to OCI Registry
              run: |
                  helm push dist/${{ env.CHART_NAME }}-${{ steps.version.outputs.version }}.tgz oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts

            - name: Summary
              run: |
                  echo "### Helm Chart Published ðŸš€" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Chart:** ${{ env.CHART_NAME }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "Install with:" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
                  echo "helm install kubecrsh oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts/${{ env.CHART_NAME }} --version ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
